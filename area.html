<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Climbing Area</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;1,100;1,300;1,400;1,500;1,700&family=Libre+Baskerville:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body class="area-page">
  <header class="site-header">
    <div class="header-content">
      <div class="site-branding">
        <img src="images/logo/front-icon_rocks.png" alt="KjugeBloc logo" class="logo">
        <h1>KjugeBloc</h1>
      </div>
      <nav>
        <ul class="nav-links">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="access.html">Access</a></li>
          <li><a href="area-index.html" class="active">Area Index</a></li>
          <li><a href="map.html">Map</a></li>
          <li><a href="accomodation.html">Accomodation</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <h1 id="area-title">Loading area...</h1>
    <p>Showing all problems in the selected area, sorted by grade.</p>
    <div>
      <section id="problems-section"></section>
    </div>
  </main>

  <footer>
    <p>Â© 2025 KjugeBloc</p>
  </footer>

  <script>
    const params = new URLSearchParams(window.location.search);
    const areaName = params.get('area');
    document.getElementById('area-title').textContent = areaName || 'Unknown Area';

    const sheetId = '1VwZM08gTUNHlpWGDaBUWnYdiqgUFicWoD3fDJJwE7rU';
    const sheetName = 'databas';
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;

    fetch(url)
      .then(res => res.text())
      .then(data => {
        const json = JSON.parse(data.substring(47).slice(0, -2));
        const rows = json.table.rows;

        const problemsByGrade = {};

        rows.forEach(row => {
          const cols = row.c;
          const area = cols[2]?.v;
          const name = cols[8]?.v;
          const grade = cols[9]?.v;

          if (area === areaName && name && grade) {
            const rating = cols[12]?.v || '';
            problemsByGrade[grade] ??= [];
            problemsByGrade[grade].push({
              name: name,
              expo: cols[11]?.v || '',
              rating: rating,
              faYear: cols[20]?.v || '',
              circ: cols[7]?.v || '',
              starScore: rating === 'â˜…' ? 2 : rating === 'â˜†' ? 1 : 0,
              imageFiles: cols[18]?.v || ''
              video: cols[17]?.v || ''
            });
          }
        });

        const gradeOrder = [
          'P', '8C', '8B+', '8B', '8A+', '8A',
          '7C+', '7C', '7B+', '7B', '7A+', '7A',
          '6C+', '6C', '6B+', '6B', '6A+', '6A',
          '5+', '5', 'L', 'â€“'
        ];

        const sortedGrades = Object.keys(problemsByGrade).sort((a, b) => {
          const indexA = gradeOrder.indexOf(a);
          const indexB = gradeOrder.indexOf(b);
          return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
        });

        const section = document.getElementById('problems-section');

        if (sortedGrades.length === 0) {
          section.innerHTML = '<p>No problems found for this area.</p>';
          return;
        }

        sortedGrades.forEach(grade => {
          const gradeHeader = document.createElement('h2');
          gradeHeader.textContent = grade;
          section.appendChild(gradeHeader);

          const list = document.createElement('ul');
          problemsByGrade[grade]
            .sort((a, b) => {
              if (b.starScore !== a.starScore) return b.starScore - a.starScore;
              return a.name.localeCompare(b.name);
            })
            .forEach(problem => {
              const li = document.createElement('li');

              const hasImages = problem.imageFiles.trim() !== '';
              const hasVideo = problem.video?.trim() !== '';
              const cameraIcon = (hasImages || hasVideo) ? 'ðŸ“·' : '';
              const isPGrade = grade === 'P';
              const nameStyle = isPGrade ? 'style="color: #999999;"' : '';

              li.innerHTML = `
                <div class="problem-row">
                  <span class="camera-icon">${cameraIcon}</span>
                  <a href="problem.html?name=${encodeURIComponent(problem.name)}" class="problem-name-link">
                    <strong ${nameStyle}>${problem.name}</strong>
                  </a>
                  <span class="problem-meta">
                    <span class="rating">${problem.rating}</span>
                    <span class="expo">${problem.expo}</span>
                    <span class="fa-year">${problem.faYear}</span>
                    ${problem.circ !== '-' ? `<span class="circ">${problem.circ}</span>` : ''}
                  </span>
                </div>
              `;
              list.appendChild(li);
            });
          section.appendChild(list);
        });
      })
      .catch(err => {
        console.error('Error loading data:', err);
        document.getElementById('problems-section').innerHTML = '<p style="color: red;">Failed to load problems.</p>';
      });
  </script>
</body>
</html>
